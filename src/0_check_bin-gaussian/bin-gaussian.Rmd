---
title: "Binomial of sum of Gaussians versus sum of binomial of Gaussians"
author: "Adam Howes"
output: html_document
---

```{r}
#' Binomial of sum of Gaussians versus sum of binomial of Gaussians
#' IID latent field
#' Without aggregation:
#' `y = \sum_{i = 1}^n y_i$, $y_i \sim \text{Bin}(m, \rho_i)$, $\rho_i \sim \text{Logitnormal}(\mu, \sigma^2)`
#' With aggregation:
#' `y \sim \text{Bin}(nm, \bar \rho)$, $\bar \rho = \frac{1}{n} \sum_{i = 1}^n \rho_i$, $\rho_i \sim \text{Logitnormal}(\mu, \sigma^2)`

experiment <- function(nsim, n, phi_mean, phi_sd, y_sample_size) {
  phi <- rnorm(n, phi_mean, phi_sd)
  rho <- plogis(phi)
  m <- rep(y_sample_size, n)

  #' Without aggregation
  y <- replicate(nsim, rbinom(n, m, rho), simplify = FALSE)
  y <- lapply(y, sum)

  #' With aggregation (at the level of the latent field)
  y_agg <- replicate(nsim, rbinom(1, sum(m), weighted.mean(rho)), simplify = FALSE)

  return(list(y = unlist(y), y_agg = unlist(y_agg), phi = phi, rho = rho))
}

plot_hist <- function(result) {
  data.frame(
    type = c(rep("No aggregation (truth)", nsim), rep("Aggregation (approximation)", nsim)),
    y = c(result$y, result$y_agg)
  ) %>%
    ggplot() +
    geom_histogram(aes(x = y, fill = type), alpha = 0.5, position = "identity") +
    theme_minimal() +
    theme(
      legend.position = "bottom"
    )
}

nsim <- 500
n <- 36

#' Low prevalence setting (disease)
result <- experiment(nsim, n, -2.5, 0.5, 30)
plot(result$rho) #' This is what the underlying latent field looks like for these settings

plot_hist(result) #' And then the difference between the truth and the aggregated approximation

sd(result$y)
sd(result$y_agg)
sd(result$y_agg) / sd(result$y) #' Ratio

#' Probability approximately 1/2 setting (elections)
#' As before but with different `phi_mean` settings:
result_half <- experiment(nsim, n, 0, 0.5, 30)
plot(result_half$rho)

plot_hist(result_half)

sd(result_half$y)
sd(result_half$y_agg)
sd(result_half$y_agg) / sd(result_half$y) #' Ratio

#' Conclusions, things to add:
#' * Standard deviation of aggregation tends to overestimate true standard deviation,
#' * Effect is larger in the small `\rho` setting than the large `\rho` setting
#' * Should test latent field with spatial structure e.g. ICAR latent field and so on
#' * What is the effect of varying `sd_phi`? What is the effect of varying `y_sample_size`?
```
